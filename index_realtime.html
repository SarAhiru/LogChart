<!-- リアルタイム みらスク連携ver. -->

<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>

  <!--Vue.jsの読み込み-->
  <!-- <script src="https://unpkg.com/vue@3.2.31"></script> -->
  <!--Chart.jsの読み込み-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
  <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->
  <script src="https://code.jquery.com/jquery-3.0.0.min.js"></script>

  <link rel="stylesheet" href="StyleSheet0.css" />
  <title>学習履歴 可視化</title>
</head>

<body>

  <!--.jsと連携-->
  <script type="text/javascript" src="actor.js"></script>
  <script type="text/javascript" src="lavel.js"></script>
  <script type="text/javascript" src="count.js"></script>
  <!-- <script type="text/javascript" src="getlog.js"></script> -->

  <!--英語　ログ　(棒グラフ)　[機能合計]-->
  <script type="text/javascript" src="totalChart1min.js"></script>
  <!-- ヒートマップ -->
  <script src="heatmap.js"></script>
  <!--英語　ログ　(棒グラフ)　[機能ごと]-->
  <script type="text/javascript" src="targetEnChart1min.js"></script>
  <!--英語　ログ　人数合計(棒グラフ)　[全体]-->
  <script type="text/javascript" src="numChart1min.js"></script>


  <header>
    <form>
      <p>
        <br>
        リアルタイム
      </p>
    </form>
  </header>


  <p>
    <input type="button" onclick="location.href='./EnglishSound.html'" value="音声再生">
    <input type="button" onclick="location.href='./classseat.html'" value="　座席　">
    <a href="index.html">過去のデータを使う</a>　　
    <!-- <a href="dataSet.html">データ登録</a> -->

    <form name="f1">
      　<INPUT type="button" value="記録停止中" style="background:#c8eac3" onClick="yesno(0)">
      </form>
    <script language="JavaScript">
      var f=new Array(3);
      f[0]=0;
      f[1]=0;
      f[2]=0;
      
      function yesno(b){
        if (f[b]==0){
          document.f1.elements[b].value='　記録中　';
          document.f1.elements[b].style.background='#1a720d';
          document.f1.elements[b].style.color='#FFFFFF';
          f[b]=1;
        } else {
          document.f1.elements[b].value='記録停止中';
          document.f1.elements[b].style.background='#c8eac3';
          document.f1.elements[b].style.color='#000000';
          f[b]=0;
        }
      }
      </script>


    <!-- <div class="example2">
      <input type="checkbox" checked id="1" name="example2"><label for="1">ボタン</label>
      <input type="checkbox" id="2" name="example2"><label for="2">ボタン</label>
      <input type="checkbox" id="3" name="example2"><label for="3">ボタン</label>
    </div>
    <style>
      .example2{
          display: flex;
      }
      .example2 label{
          display: block;
          width: 150px;
          background: #c8eac3;
          color: #000;
          padding: 10px;
          margin: 10px;
          box-sizing: border-box;
          text-align: center;
          text-decoration: none;
          border-radius: 30px;
          cursor: pointer;
      }
      .example2 input:checked+label{
          background: #1a720d;
          color: #FFF;
      }
      .example2 input{
          display: none;
      }
      </style> -->
      
  </p>
  <br>

  <article>
    <!-- <h1>個人表示</h1> -->
    <div>
      <p>＝児童ごとの操作回数の合計＝</p>
      <!--<div style="width:50%;"></div>-->
      <canvas id="studentChart" width="300" height="100"></canvas>
    </div>
    <div>
      <canvas id="heatMap" width="300" height=" 150"></canvas>
    </div>
    <br><br>
    <div>
      <p>＝機能ごとの操作回数の合計＝</p>
      <canvas id="targetChart" width="300" height=" 100"></canvas>
    </div>
    <br><br>
    <div>
      <p>＝操作人数の合計＝</p>
      <canvas id="numChart" width="300" height=" 100"></canvas>
    </div>
    <br><br>
  </article>


  <!--以下でデータの読み込みを行う-->
  <script>
    let result = []; //csvの中身
    let dataLength = 0; //データの長さ
    let member = []; //生徒
    let memberID;
    let memberNum;

    let time = []; //時間
    let num = []; //回数

    let startnum = 0;
    let finishnum = 0;
    // let choiceday = "2022/4/22";

    let today = new Date();
    let year = today.getFullYear();
    let month = today.getMonth() + 1;
    let day = today.getDate();
    let date = year + "-" + month + "-" + day;
    // let date = "2022-3-3";
    // let date = "2022-6-23";
    console.log(date);

    // 各グラフの型を表示させておく
    drawBarChart(member, time, num);
    heatmap(member, time, num);
    drawChartTarget2(result, time, startnum, finishnum);
    drawStuNumChart(member, time, num);


    // XMLHttpRequestオブジェクトの作成
    var request = new XMLHttpRequest();
    // URLを開く
    request.open('GET', 'https://staging.mirai-pf.jp/maker1/get_study_log/index.html', true);
    // リクエストをURLに送信
    request.send();

    // レスポンスが返ってきた時 
    request.onload = function () {
      // レスポンスが返ってきた時の処理
      var data = this.response;
      console.log(data);

      var user_manage_id = document.getElementById("user_manage_id").value;
      user_manage_id.value = 33788;
      var user_id = document.getElementById("user_id").value;
      user_id = 'katonaoki';
      var content_id = document.getElementById("content_id").value;
      content_id = 'FSI_TEST_SANSUU';
      // var find_begin = document.getElementById("find_begin").value;
      // var find_end = document.getElementById("find_end").value;
      var sort_type = document.getElementById("sort_type").value;
      sort_type = 1;
      // var top = document.getElementById("top").value;
      // var limit = document.getElementById("limit").value;
      // var begin_check = document.getElementById("begin_check").checked;
      // begin_check.checked = true;
      // var end_check = document.getElementById("end_check").checked;
      // end_check.checked = true;


      // csvファイルになる前のデータ配列を'result'内に入れていきたい

      var data = doc.val();// 新しく取得したデータ
      result.push([data.time, data.index, data.actor, data.action, data.bookId, data.chapter, data.type, data.pageIdx, data.appId, data.target]);
    };



    //日時でソート
    result.sort(function (a, b) {
      if (a > b) {
        return 1;
      } else {
        return -1;
      }
    });


    member[0] = '33788_katonaoki';
    console.log(result);
    //横軸を決定
    [time, startTime, finishTime] = lavel2(result);

    startnum = 0;
    finishnum = result.length - 1;
    num = countttt(result, member, time, startnum, finishnum);

    if (studentChart) {
      studentChart.destroy();
    }
    if (heatMap) {
      heatMap.destroy();
    }
    if (targetChart) {
      targetChart.destroy();
    }
    if (numChart) {
      numChart.destroy();
    }

    drawBarChart(member, time, num);
    heatmap(member, time, num);
    drawChartTarget2(result, time, startnum, finishnum);
    drawStuNumChart(member, time, num);


    // // var db = firebase.database().ref("本町小学校_5年2組/" + date);
    // var db = firebase.database();

    // // db.ref("本町小学校_5年2組")
    // db.ref("test学校_5年1組")
    //   .get().then((doc) => {
    //     if (doc.exists) {
    //       // memberID = doc.data().actorID;
    //       // memberNum = doc.data().student_num;
    //       memberID = doc.val().actorID;
    //       memberNum = doc.val().student_num;
    //       console.log(memberID);
    //       console.log(memberNum);
    //       // console.log("ssss");
    //       for (let i = 1; i <= memberNum; i++) {
    //         let id;
    //         if (i < 10) {
    //           id = "0" + i;
    //         } else {
    //           id = i;
    //         }
    //         member[i - 1] = memberID + id;
    //       }
    //       console.log(member);
    //     } else {
    //       // doc.data() will be undefined in this case
    //       console.log("No such document!");
    //     }
    //   }).catch((error) => {
    //     console.log(`データの取得に失敗しました (${error})`);
    //   });

    // // db.ref("本町小学校_5年2組/" + date)//.orderBy("time")//.limit(1)
    // db.ref("test学校_5年1組/" + date)
    //   .get()
    //   .then((query) => {
    //     result = [];
    //     query.forEach((doc) => {
    //       // var data = doc.data();
    //       var data = doc.val();

    //       result.push([data.time, data.index, data.actor, data.action, data.bookId, data.chapter, data.type, data.pageIdx, data.appId, data.target]);
    //     });
        // console.log(result);
        // //横軸を決定
        // [time, startTime, finishTime] = lavel2(result);

        // startnum = 0;
        // finishnum = result.length - 1;
        // num = countttt(result, member, time, startnum, finishnum);
        // // num = count2(result, member, time);

        // if (studentChart) {
        //   studentChart.destroy();
        // }
        // if (heatMap) {
        //   heatMap.destroy();
        // }
        // if (targetChart) {
        //   targetChart.destroy();
        // }
        // if (numChart) {
        //   numChart.destroy();
        // }

        // drawBarChart(member, time, num);
        // heatmap(member, time, num);
        // drawChartTarget2(result, time, startnum, finishnum);
        // drawStuNumChart(member, time, num);
      // })
      // .catch((error) => {
      //   console.log(`データの取得に失敗しました (${error})`);
      // });

    




    // // これは嫌過ぎた
    // // const timer = 6000    // ミリ秒で間隔の時間を指定
    // // window.addEventListener('load', function () {
    // //   setInterval('location.reload()', timer);
    // //   console.log("更新");
    // // });

    // // var dbChange = firebase.database().ref("本町小学校_5年2組/" + date);
    // // var dbChange = firebase.database().ref("本町小学校_5年2組");
    // // var dbChange = firebase.database().ref("test学校_5年1組");

    // // comments以下に追加があった時に発動
    // // dbChange.on('child_added', function (data) {
    // dbChange.on('value', function (data) {
    //   addCommentElement(data.val());
    //   console.log("変更きたよ");
    // });

    // // const timer = 6000    // ミリ秒で間隔の時間を指定
    // // window.addEventListener('load', function () {
    // //   setInterval('addCommentElement()', timer);
    // //   console.log("更新");
    // // });

    // function addCommentElement() {
    //   db.ref("test学校_5年1組/" + date)
    //     .get()
    //     .then((query) => {
    //       result = [];
    //       query.forEach((doc) => {
    //         // var data = doc.data();
    //         var data = doc.val();

    //         result.push([data.time, data.index, data.actor, data.action, data.bookId, data.chapter, data.type, data.pageIdx, data.appId, data.target]);
    //       });
    //       console.log(result);
    //       //横軸を決定
    //       [time, startTime, finishTime] = lavel2(result);

    //       startnum = 0;
    //       finishnum = result.length - 1;
    //       num = countttt(result, member, time, startnum, finishnum);
    //       // num = count2(result, member, time);

    //       if (studentChart) {
    //         studentChart.destroy();
    //       }
    //       if (heatMap) {
    //         heatMap.destroy();
    //       }
    //       if (targetChart) {
    //         targetChart.destroy();
    //       }
    //       if (numChart) {
    //         numChart.destroy();
    //       }

    //       drawBarChart(member, time, num);
    //       heatmap(member, time, num);
    //       drawChartTarget2(result, time, startnum, finishnum);
    //       drawStuNumChart(member, time, num);
    //     })
    //     .catch((error) => {
    //       console.log(`データの取得に失敗しました (${error})`);
    //     });
    // }


  </script>
  <br><br>
</body>

</html>